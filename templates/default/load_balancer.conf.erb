upstream <%= @resource.application.name %> {
  <% unless @application_socket.empty? -%>
    <% @application_socket.each do |socket_name| -%>
  server unix:<%= socket_name %>;
    <% end -%>
  <% end -%>
  <% @hosts.each do |node| %>
  server <%= node %>:<%= @resource.application_port %>;
  <% end %>
}

<% if @resource.ssl %>
server {
  listen <%= @resource.port %>;
  server_name <%= @resource.server_name.is_a?(Array) ? @resource.server_name.join(' ') : @resource.server_name %>;
  return 301 https://$host:<%= @resource.ssl_port %>$request_uri;
}
<% end %>

server {
listen <%= @resource.ssl ? @resource.ssl_port : @resource.port %><%= @resource.ssl ? ' ssl' : '' %>;
  server_name <%= @resource.server_name.is_a?(Array) ? @resource.server_name.join(' ') : @resource.server_name %>;
  <% if @resource.ssl %>
  ssl_certificate <%= @resource.ssl_certificate %>;
  ssl_certificate_key <%= @resource.ssl_certificate_key %>;
  <% end %>
  <% if @resource.ssl_redirect %>
  if ($http_x_forwarded_proto = "http") {
    return 301 https://<%= @resource.server_name.is_a?(Array) ? @resource.server_name.join(' ') : @resource.server_name %>$request_uri;
  }
  <% end %>
  <% @resource.static_files.each do |url, path| %>
  location <%= url %> {
    alias <%= path %>/;
    index index.html index.htm;

    proxy_intercept_errors on;
    error_page 404 https://zahpee.com;
  }
  <% end %>
  location <%= @resource.application_prefix %>/ {
    proxy_pass http://<%= @resource.application.name %>/;
    <% if @resource.set_host_header %>
    proxy_set_header   Host             $host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    <% end %>
  }
  location <%= @resource.application_prefix %> {
    proxy_pass http://<%= @resource.application.name %>/;
    <% if @resource.set_host_header %>
    proxy_set_header   Host             $host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    <% end %>
  }
}

server {
  listen 80;
  server_name uimbi.com www.uimbi.com uimbi.com.br www.uimbi.com.br;
  rewrite      ^ http://offers.zahpee.com/painel-eventos-redes-sociais?;
}
